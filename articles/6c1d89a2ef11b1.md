---
title: "Semantic Kernel ã® Planner ã‚’ç”¨ã„ã€è¤‡æ•° Plugin ã‚’æŸã­ãŸå‡¦ç†ã‚’ã™ã‚‹"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["SemanticKernel", "AI"]
published: true
---

é•·ã„ã“ã¨ https://normalian.hatenablog.com/ ã§ãƒ–ãƒ­ã‚°ã‚’æ›¸ã„ã¦ã„ã¾ã—ãŸãŒã€æ˜¨ä»Šã®æµè¡Œã«å¾“ã„ Zenn å´ã§ã‚‚è¨˜äº‹ã‚’æ›¸ã„ã¦ã¿ã‚ˆã†ã¨ã“ã¡ã‚‰ã§ã‚‚è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¦ã„ãã¾ã™ã€‚åˆå›ã¨ãªã‚‹ä»Šå›ã¯ Semantic Kernel ã‚’ãƒ†ãƒ¼ãƒã«ã—ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
Semantic Kernel ã®æ¦‚è¦è‡ªä½“ã¯æ–¹ã€…ã®ãƒ–ãƒ­ã‚°ã«è¨˜äº‹ãŒã‚ã‚‹ã®ã§å‰²æ„›ã—ã¾ã™ãŒã€Microsoft ç‰ˆ LangChain ã¨æ€ã£ã¦é ‚ã‘ã‚Œã°å¤§ããªèªè­˜ç¥–èªã¯ãªã„ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã®å…¬å¼ GitHub ã‚µã‚¤ãƒˆã‚’å‚ç…§ã—ã¦é ‚ã‘ã‚Œã°æ¦‚è¦è‡ªä½“ã¯ã¤ã‹ã‚ã‚‹ã“ã¨ã«åŠ ãˆã€C# ã ã‘ã§ãªã Python ã‚„ Java ã‚‚è¨€èªã¨ã—ã¦ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ï¼ˆå„è¨€èªã”ã¨ã«é€²æ—å·®ç•°ã¯ã‚ã‚Šã¾ã™ãŒï¼‰ã€‚
https://github.com/microsoft/semantic-kernel

## Planner ã¨ Plugin ã£ã¦ï¼Ÿ

ä»Šå›ãƒ†ãƒ¼ãƒã«ã—ãŸã„ã®ã¯æ²é¡Œã§ã‚‚ã‚ã‚‹ Planner ã§ã™ã€‚Semantic Kernel ã¯ OpenAI ã‚’æ´»ç”¨ã—ã¦æ§˜ã€…ãªè¤‡é›‘ãªå•é¡Œã‚’è§£æ±ºã™ã‚‹ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã—ã¦ãã‚Œã¾ã™ãŒã€OpenAI è‡ªä½“ã¯ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚„ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™ç­‰ã® IO å‡¦ç†ã‚’å«ã‚ã€ã„ãã¤ã‹ã®å‡¦ç†ã¯ãã®ã¾ã¾ã§ã¯ã§ãã¾ã›ã‚“ã€‚
Semantic Kernel ã«ãŠã„ã¦ã€ãã†ã„ã£ãŸå€‹åˆ¥ã®æ‹¡å¼µçš„ãªæ©Ÿèƒ½ã‚’å®Ÿç¾ã™ã‚‹ã®ãŒ Plugin ã¨ãªã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã§æœ‰ã‚Œã°ä»¥ä¸‹ã®æ§˜ã« FileIOPlugin ãŒæ¨™æº–ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/microsoft/semantic-kernel/blob/main/dotnet/src/Plugins/Plugins.Core/FileIOPlugin.cs

FileIOPlugin è‡ªä½“ã¯æ¨™æº–ã§æä¾›ã•ã‚Œã¦ã„ã‚‹ Plugin ãªã®ã§ã€NuGet ã§ Microsoft.SemanticKernel.Plugins.Core ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€ä»¥ä¸‹ã®æ§˜ã« ImportPluginFromType ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç”¨ã„ã¦ Semantic Kernel ã® Kernel ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«èª­ã¿è¾¼ã‚€ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Planning.Handlebars;
using Microsoft.SemanticKernel.Plugins.Core;
using System.Text;

using ILoggerFactory loggerFactory = LoggerFactory.Create(builder =>
{
    builder.AddConsole();
    builder.SetMinimumLevel(LogLevel.Warning);
});

#pragma warning disable SKEXP0050, SKEXP0060
var builder = Kernel.CreateBuilder();
builder.Services.AddSingleton(loggerFactory);
builder.AddAzureOpenAIChatCompletion(deployment, endpoint, apiKey);

var kernel = builder.Build();
kernel.ImportPluginFromType<FileIOPlugin>();
```

æ›´ã«ã“ã®èª­ã¿è¾¼ã‚“ã  Plugin ã« Planner ã‚’æ´»ç”¨ã—ã¦å®Ÿéš›ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã«åŠ ãˆã¦ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚

```csharp
string filename = @"test.txt ";

// This code as follows can read the file directly.
Console.WriteLine("========================================== Start plan");
{
    // Create a plan
    var planner = new HandlebarsPlanner(new HandlebarsPlannerOptions() { AllowLoops = true });
    var plan = await planner.CreatePlanAsync(kernel, $"Please read {filename} file on current directory");
    Console.WriteLine($"Plan: {plan}");

    // Execute the plan
    Console.WriteLine("========================================== Start execute plan");
    var result = (await plan.InvokeAsync(kernel)).Trim();
    Console.WriteLine($"Results: {result}");
}
```
ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®ã†ã¡äºŒã¤ç›®ã® Console.WriteLine($"Plan: {plan}") ã§ã©ã®æ§˜ãª Plan ãŒä½œæˆã•ã‚ŒãŸã‹ã‚’ç¢ºèªã§ãã¾ã™ï¼ˆã“ã®æ™‚ç‚¹ã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç­‰ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ï¼‰ã€‚å®Ÿè¡Œçµæœä¾‹ã¨ã—ã¦ã¯ä»¥ä¸‹ã®æ§˜ã«ãªã‚Šã¾ã™ã€‚ç‰¹ã« Plan éƒ¨åˆ†ã«é–¢ã—ã¦ã€Planner ãŒã©ã®æ§˜ãª step ã§ Plugin ç­‰ã‚’åˆ©ç”¨ã—ã¦å‡¦ç†ã‚’è¡Œã†ã‹ãŒç¢ºèªã§ãã¾ã™ã€‚

```txt
========================================== Start applicaion
========================================== Start plan
Plan: {{!-- Step 0: Extract Key Values --}}
{{set "path" "test.txt"}}

{{!-- Step 1: Read the file --}}
{{set "fileContent" (FileIOPlugin-Read path=path)}}

{{!-- Step 2: Print the file content --}}
{{json fileContent}}
========================================== Start execute plan
Results: You can read this sentences if your Semantic Kernel application works well.
ã‚ãªãŸã®äºˆæƒ³ã«åã—ã¦ã€ã“ã®æ–‡ç« ãŒè¦‹ãˆã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹?
========================================== End of Application
```

ã“ã¡ã‚‰ã®ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨ç‰ˆã¯ä»¥ä¸‹ã«ã‚ã‚‹ã®ã§å¿…è¦ãªå ´åˆã¯å‚ç…§ãã ã•ã„ã€‚
https://github.com/normalian/normalian-sk-samples/blob/main/PlannerFileReadSample01/Program.cs

ã¡ãªã¿ã« ImportPluginFromType ã§ FileIOPlugin ã‚’èª­ã¿è¾¼ã¾ãšã«ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´åˆã¯ä»¥ä¸‹ã®æ§˜ãªå®Ÿè¡Œçµæœã«ãªã‚Šã¾ã™ã€‚ä»¥ä¸‹ã®æ§˜ã«ã‚ã‚Šã‚‚ã—ãªã„ Example-ReadFile ã¨ã„ã† Plugin ã‚’
```txt
========================================== Start applicaion
========================================== Start plan
Plan: {{!-- Step 0: Extract key values --}}
{{!-- No key values needed for this goal --}}

{{!-- Step 1: Read test.txt file --}}
{{set "fileContent" (Example-ReadFile path="test.txt")}}

{{!-- Step 2: Print the file content --}}
{{json fileContent}}
========================================== Start execute plan
fail: Microsoft.SemanticKernel.Planning.Handlebars.HandlebarsPlan[0]
      Plan execution failed. Error: [HallucinatedHelpers] The plan references hallucinated helpers: Helper 'Example-ReadFile'
      Microsoft.SemanticKernel.KernelException: [HallucinatedHelpers] The plan references hallucinated helpers: Helper 'Example-ReadFile'
       ---> HandlebarsDotNet.HandlebarsRuntimeException: Template references a helper that cannot be resolved. Helper 'Example-ReadFile'
         at HandlebarsDotNet.Helpers.MissingHelperDescriptor.Invoke(HelperOptions& options, Context& context, Arguments& arguments)
         at HandlebarsDotNet.Helpers.MissingHelperDescriptor.HandlebarsDotNet.Helpers.IHelperDescriptor<HandlebarsDotNet.HelperOptions>.Invoke(HelperOptions& options, Context& context, Arguments& arguments)
         at HandlebarsDotNet.Helpers.LateBindHelperDescriptor.Invoke(HelperOptions& options, Context& context, Arguments& arguments)
```

## Planner ã§è¤‡æ•°ã® Plugin ã‚’å‘¼ã¶
ä¸Šè¨˜ã ã‘ã§ã¯ã€Œå˜ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚€æ“ä½œã‚’ä½¿ã£ãŸã ã‘ã ã‚ˆã­ï¼Ÿã€ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€ã‚‚ã†å°‘ã—è¤‡é›‘ãªã‚·ãƒŠãƒªã‚ªã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚æ¬¡ã¯ä»¥ä¸‹ã‚’åŒæ™‚ã«è¡Œã„ã¾ã™ã€‚
+ ç‰¹å®šã® URL ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™
+ çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã™ã‚‹

ä¸Šè¨˜ã§ã®äºŒã¤ã®å‡¦ç†ã¯ã€ãã‚Œãã‚Œ OpenAI å˜ç‹¬ã§ã¯é›£ã—ã„å‡¦ç†ã§ã€è‡ªåˆ†ã§ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§è¨˜è¼‰ã™ã‚‹å‡¦ç†ã¨çµ„ã¿åˆã‚ã›ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã¡ã‚‰ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ä¸‹ã•ã„ã€‚
```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.Planning.Handlebars;
using Microsoft.SemanticKernel.Plugins.Core;
using System.Text;

Console.WriteLine("========================================== Start applicaion");

Console.OutputEncoding = Encoding.GetEncoding("utf-8");
var configuration = new ConfigurationBuilder()
    .AddUserSecrets("90cdbb2e-9f8f-4322-8837-f59e9e4b4703")
    .Build();
var deployment = configuration["AzureOpenAI:Deployment"];
var endpoint = configuration["AzureOpenAI:Endpoint"];
var apiKey = configuration["AzureOpenAI:ApiKey"];
using ILoggerFactory loggerFactory = LoggerFactory.Create(builder =>
{
    builder.AddConsole();
    builder.SetMinimumLevel(LogLevel.Warning);
});

#pragma warning disable SKEXP0050, SKEXP0060
var builder = Kernel.CreateBuilder();
builder.Services.AddSingleton(loggerFactory);
builder.AddAzureOpenAIChatCompletion(deployment, endpoint, apiKey);

var kernel = builder.Build();
kernel.ImportPluginFromType<HttpPlugin>();
kernel.ImportPluginFromType<FileIOPlugin>();

var uri = "https://raw.githubusercontent.com/normalian/My-Azure-Portal-ChromeExtension/master/README.md";
var filename = "response_message.txt";

Console.WriteLine("========================================== Start make plan");
{
    // Create a plan
    var planner = new HandlebarsPlanner(new HandlebarsPlannerOptions() { AllowLoops = true });
    var plan = await planner.CreatePlanAsync(kernel, $"Please send http request to {uri} and save the response as {filename} file on current directory.");
    Console.WriteLine($"Plan: {plan}");

    // Execute the plan
    Console.WriteLine("========================================== Start execute plan");
    var result = (await plan.InvokeAsync(kernel)).Trim();
    Console.WriteLine($"Results: {result}");
}
#pragma warning restore SKEXP0050, SKEXP0060
Console.WriteLine("========================================== End of Application ");
```

ã“ã¡ã‚‰ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨ç‰ˆã¯ä»¥ä¸‹ã«é…ç½®ã—ãŸã®ã§ã€ã”å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
https://github.com/normalian/normalian-sk-samples/tree/main/PlannerWith2PluginsSample01

